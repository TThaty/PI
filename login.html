<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio de Sesión</title>
    <link rel="stylesheet" href="estilos.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <h1>Gestión de maquinaria</h1>
    </header>

    <main class="d-flex justify-content-center align-items-center" style="margin-top: 70px;">
        <div class="card p-4 shadow" style="width: 400px;">
            <h2 class="text-center mb-4">Inicio de Sesión</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label for="name" class="form-label">Nombre de usuario</label>
                    <input type="text" class="form-control" id="username" placeholder="Usuario" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="password" placeholder="Ingresa tu contraseña" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button>
            </form>
            <div class="mt-3 text-center">
                <a href="recuperar-contraseña.html" class="text-decoration-none">¿Olvidaste tu contraseña?</a>
            </div>
        </div>
    </main>

    <script>
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById("username").value.trim();
            const password = document.getElementById("password").value.trim();
            const listaActualUsuarios = JSON.parse(localStorage.getItem("usuarios")) || [];

            const usuarioEncontrado = listaActualUsuarios.find(usuario => usuario.username === username && usuario.password === password);

            if (usuarioEncontrado) {
                // Generar token con expiración de 120 minutos
                const token = {
                    value: Math.random().toString(36).substr(2), // Genera un token aleatorio
                    expiration: Date.now() + 120 * 60 * 1000 // 120 minutos en milisegundos
                };

                // Guardar usuario y token en localStorage
                localStorage.setItem("usuarioActual", JSON.stringify(usuarioEncontrado));
                localStorage.setItem("tokenSesion", JSON.stringify(token));

                alert("Inicio de sesión exitoso");
                window.location.href = "pagina-principal.html";
            } else {
                alert("Credenciales incorrectas. Por favor, inténtalo de nuevo.");
            }
        }

        function iniciarSesion() {
            let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            let usuario = usuarios.find(u => u.username === username && u.password === password);

            if (usuario) {
                if (usuario.cambioContrasenaRequerido) {
                    alert("Debes cambiar tu contraseña antes de continuar.");
                    abrirFormularioContrasena(usuario.nombre);
                } else {
                    localStorage.setItem("usuarioActual", JSON.stringify(usuario));
                    window.location.href = "dashboard.html";
                }
            } else {
                mostrarAlerta("Usuario o contraseña incorrectos.", "danger");
            }
        }

        // Función para verificar si la sesión ha expirado
        function verificarSesion() {
            const tokenSesion = JSON.parse(localStorage.getItem("tokenSesion"));

            // Si no hay token de sesión, no hacer nada (no mostrar mensaje)
            if (!tokenSesion) return;

            // Si el token ha caducado, eliminar la sesión y redirigir al login
            if (Date.now() > tokenSesion.expiration) {
                localStorage.removeItem("usuarioActual");
                localStorage.removeItem("tokenSesion");

                alert("Tu sesión ha expirado. Por favor, inicia sesión nuevamente.");
                window.location.href = "index.html"; // Redirigir al login
            }
        }

        // Verificar sesión solo si ya había una iniciada antes
        window.onload = verificarSesion;

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
